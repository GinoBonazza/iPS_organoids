---
title: "QC_integration_annotation"
author: "GinoBonazza (ginoandrea.bonazza@usz.ch)"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: inline
---

```{r knitr config, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(warning = FALSE)

knitr::opts_chunk$set(message = FALSE)

knitr::opts_chunk$set(cache = FALSE)

knitr::opts_chunk$set(dpi = 600, fig.align = "center")
```

## Setup

```{r setup, class.source = "fold-hide"}
# Get current file name to make folder
current_file <- "QC_integration_annotation"

# Load libraries
library(here)
library(readr)
library(readxl)
library(xlsx)
library(Seurat)
library(DropletUtils)
library(Matrix)
library(scDblFinder)
library(scCustomize)
library(dplyr)
library(ggplot2)
library(magrittr)
library(tidyverse)
library(reshape2)
library(S4Vectors)
library(SingleCellExperiment)
library(pheatmap)
library(png)
library(gridExtra)
library(knitr)
library(scales)
library(RColorBrewer)
library(Matrix.utils)
library(tibble)
library(ggplot2)
library(scater)
library(patchwork)
library(statmod)
library(ArchR)
library(clustree)
library(speckle)
library(ggplot2)
library(scater)
library(gprofiler2)
library(clusterProfiler)
library(org.Hs.eg.db)
library(AnnotationHub)
library(ReactomePA)
library(speckle)

#Output paths
output_dir_data <- here::here("output", current_file)
if (!dir.exists(output_dir_data)) dir.create(output_dir_data)

if (!dir.exists(here::here("docs", "figure"))) dir.create(here::here("docs", "figure"))

output_dir_figs <- here::here("docs", "figure", paste0(current_file, ".Rmd"))
if (!dir.exists(output_dir_figs)) dir.create(output_dir_figs)
```


## Quality Control


```{r}
iPS_integrated <- readRDS(here::here(output_dir_data, "iPS_integrated.rds"))
```


```{r Cell_type_sample_table, fig.height=3, fig.width=8, message=FALSE, warning=FALSE}
# Extract metadata
metadata <- iPS_integrated@meta.data

# Create a contingency table with cell types as rows and samples as columns
cell_type_sample_table <- table(metadata$cell_type, metadata$Sample)

# Convert the table to a data frame for easier manipulation
cell_type_sample_df <- as.data.frame.matrix(cell_type_sample_table)

# Add the totals per sample (column-wise sum) as the last row
cell_type_sample_df["Total", ] <- colSums(cell_type_sample_df)

# Add the totals per cell type (row-wise sum) as the last column
cell_type_sample_df$Total <- rowSums(cell_type_sample_df)

table_plot <- tableGrob(cell_type_sample_df)

ggsave(here::here(output_dir_figs, "cell_type_sample_table.png"), plot = table_plot, dpi = 600, width = 8, height = 3)

# Include the image in the markdown document
knitr::include_graphics(here::here(output_dir_figs, "cell_type_sample_table.png"), error = FALSE, dpi = 300)
```







